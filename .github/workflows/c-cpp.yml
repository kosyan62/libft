name: Build and Test

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Cache libft.a
      id: cache-libft
      uses: actions/cache@v4
      with:
        path: libft
        key: libft-${{ hashFiles('libft/**/*') }}

    - name: build libft
      if: steps.cache-libft.outputs.cache-hit != 'true'
      run: make -C libft

  test_libft:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
    - uses: actions/checkout@v4
    - uses: actions/cache@v4
      with:
        path: libft
        key: libft-${{ hashFiles('libft/**/*') }}
    - name: Install Dependencies
      run: sudo apt-get install -y libbsd-dev libncurses-dev
    - name: Install and build libft-unit-test
      run: | 
        git clone https://github.com/alelievr/libft-unit-test.git libft-unit-test && \
        make -C libft-unit-test
    - name: Run Tests
      run: bash -c "cd libft-unit-test && ./run_test"
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: results
        path: libft-unit-test/result.log
  test_printf:
    runs-on: ubuntu-latest
    needs: [build, test_libft]
    steps:
    - uses: actions/checkout@v4
    - uses: actions/cache@v4
      with:
        path: libft
        key: libft-${{ hashFiles('libft/**/*') }}
    - run: cp libft/libft.a libftprintf.a
    - name: Install and build ft_printf_tester
      run: |
        git clone https://github.com/paulo-santana/ft_printf_tester.git && \
        sed -i '/^_bonus:/ {n; d;}' ft_printf_tester/Makefile && \
        sed -i '/^${LIBFTPRINTF}:/ {n; d;}' ft_printf_tester/Makefile
    - name: Run Tests
      run: |
          pushd ft_printf_tester
          for i in {1..10}; do
            echo "Running test iteration $i"
            sh test 1 > result.log 2 > /dev/null && cat result.log
            if tail -n 1 result.log | grep -q "Tests OK"; then break; fi
            sleep 1
          done
          popd
    - name: Check result
    - run: if tail -n 1 ft_printf_tester/result.log | grep -q "100%"; then echo "Some tests failed" && exit 1; else exit 0; fi
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: printf_results
        path: ft_printf_tester/result.log